<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link rel="stylesheet" href="style.css">
  <title>Cadastro de Contatos</title>
</head>
<body>
  <div class="container-fluid">
    <header>
      <div class="p-3 mb-2 text-white" id="idCabecalho">
        <img id="editar" src="assets\logo_alphacode.png" alt="logo_alphacode">
        <h2 style="font-weight: bold;">Cadastro de Contatos</h2>
      </div>
    </header>
    <section>
      <!-- FORM WRITE -->
      <form class="form-container" id="formCadastro">
        <div class="row g-3">
          <div class="col form-group">
            <label for="nome">Nome Completo</label>
            <input type="text" class="form-control input-control" id="nome" name="nome" placeholder="Ex.: Lucas Placido dos Santos">
          </div>
          <div class="col form-group">
            <label for="data">Data de Nascimento</label>
            <input type="text" class="form-control input-control" id="data" name="data" placeholder="Ex.: 08/02/2001">
          </div>
        </div>
        <div class="row g-3">
          <div class="col form-group">
            <label for="mail">E-mail</label>
            <input type="email" class="form-control input-control" id="mail" name="mail" placeholder="Ex.: lucasplacido.work@gmail.com">
          </div>
          <div class="col form-group">
            <label for="profissao">Profissão</label>
            <input type="text" class="form-control input-control" id="profissao" name="profissao" placeholder="Ex.: Desenvolvedor Fullstack">
          </div>
        </div>
        <div class="row g-3">
          <div class="col form-group">
            <label for="telefone">Telefone para contato</label>
            <input type="text" class="form-control input-control" id="telefone" name="telefone" placeholder="Ex.: (41) 3275-4898">
          </div>
          <div class="col form-group">
            <label for="celular">Celular para contato</label>
            <input type="text" class="form-control input-control" id="celular" name="celular" placeholder="Ex.: (41) 9 9612-8992">
          </div>
        </div>
       <!-- FORM CHECKBOX -->
        <div class="row g-3">
          <div class="col">
            <input type="checkbox" class="checkbox-control" id="checkWpp" name="checkWpp">
            <label for="checkWpp">Número de celular possui WhatsApp</label>
          </div>  
          <div class="col">
            <input type="checkbox" class="checkbox-control" id="notifyEmail" name="notifyEmail">
            <label for="notifyEmail">Enviar notificações por E-mail</label>
          </div>
        </div>
        <div class="row g-3">
          <div class="col">
            <input type="checkbox" class="checkbox-control" id="notifySms" name="notifySms">
            <label for="notifySms">Enviar notificações por SMS</label>
          </div>
        </div>
        <!-- BTN SUBMIT -->
        <div class="mt-5 row">
          <div class="col d-flex justify-content-end">
            <button type="submit" id="btnCadastrar" class="btn btn-info text-white"><strong>Cadastrar Contato</strong></button>
          </div>
        </div>
      </form>
    </section>
    <br/>
    <hr/>
    <br/>
    <div class="table-responsive" id="spaceTable">
      <!-- <table style="width: 80%;" class="table">
        <thead class="table-dark">
          <tr>
            <th scope="col">Nome</th>
            <th scope="col">Data de Nascimento</th>
            <th scope="col">E-mail</th>
            <th scope="col">Celular para contato</th>
            <th scope="col">Ações</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Zézinho</td>
            <td>30/02/1999</td>
            <td>ze@gmail.com</td>
            <td>(41) 9 9612-8992</td>
            <td>
              <div>
                <img src="assets\editar.png" alt="editar">
                <img src="assets\excluir.png" alt="excluir">
              </div>
            </td>
          </tr>
        </tbody> -->
      </table>
    </div>
    <div id="spaceModal"></div>
    <footer>
      <div class="p-3 mb-2 text-white" id="idCabecalho">
        <div class="row">
          <div class="col rodape">
            <span>Termos | Políticas</span>
          </div>
          <div class="col">
            <div class = "rodape">  
              <span style="width: 100%;">© Copyright 2022 | Desenvolvido por</span>
              <img style="width: 50%; height: 75%;" src="assets\logo_rodape_alphacode.png" alt="logo_rodape_alphacode">
            </div>
          </div>
        </div>
        <div class="col d-flex justify-content-end">
          <span>©Alphacode IT Solutions 2022</span>
        </div>
      </div>
    </footer>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
  <script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>
  <script src="https://code.jquery.com/color/jquery.color-3.0.0.js" integrity="sha256-nXuT4oV5wsIpHV/V7Ay53Vf/1rg2lqpiGWoP9CRk2tM=" crossorigin="anonymous"></script>
  <script>
    function aplicar_mask_data(id){
      $(id).on('input', function(){
        var input = $(this);
        var mask = input.val();
        mask = mask.replace(/\D/g, '');
        if(mask.length > 2){
            mask = mask.replace(/(\d{2})(\d)/, '$1/$2');
        }
        if(mask.length > 5){
            mask = mask.replace(/(\d{2})(\d{2})(\d)/, '$1/$2$3');
        }
        if(mask.length > 10){
            mask = mask.substring(0, 10);
        }
        input.val(mask);
      });
    }

    function aplicar_mask_telefone(id){
      $(id).on('input', function(){
        var input = $(this);
        var mask = input.val();
        mask = mask.replace(/\D/g, '');
        if(mask.length > 10){
          mask = mask.replace(/^(\d{2})(\d{5})(\d{4}).*/, '($1) $2-$3');
        } else if(mask.length > 5){
          mask = mask.replace(/^(\d{2})(\d{4})(\d{0,4}).*/, '($1) $2-$3');
        } else if(mask.length > 2){
          mask = mask.replace(/^(\d{2})(\d{0,5})/, '($1) $2');
        } else{
          mask = mask.replace(/^(\d*)/, '($1');
        }

        input.val(mask);
      });
    }

    function formatar_data_envio(data){
      var partes = data.split('/');
      if(partes.length == 3){
        return partes[0] + partes[1] + partes[2];
      }
      return data;
    }  

    function formatar_telefone_envio(telefone){
      var numeroLimpo = telefone.replace(/\D/g, '');

      console.log(numeroLimpo);
      if(numeroLimpo.length == 10 || numeroLimpo.length == 11) 
        return numeroLimpo;
    }  

    function get_dados_table(){
        $.ajax({
          data: $(this).serialize(),
          url: "router.php?action=read", 
          type: "GET",
          dataType: 'json',
          success: function(response){
            render_table(response);
            console.log("Resposta do servidor: " + response);
          },
          error: function(){
            console.log("Erro: ");
          }
        });
    }

    $(document).ready(function(){
      get_dados_table();
      aplicar_mask_data('#data');
      aplicar_mask_telefone('#telefone');
      aplicar_mask_telefone('#celular');

      $("#formCadastro").submit(function(){
        event.preventDefault();
        var dataFormatada = formatar_data_envio($('#data').val());
        $('#data').val(dataFormatada);
        var telefoneFormatado = formatar_telefone_envio($('#telefone').val());
        $('#telefone').val(telefoneFormatado);
        var celularFormatado = formatar_telefone_envio($('#celular').val());
        $('#celular').val(celularFormatado);
        $.ajax({
          data: $(this).serialize(),
          url: "router.php?action=create", 
          type: "POST",
          dataType: "json",
          success: function(response){
            console.log("Resposta do servidor: " + response);
            get_dados_table();
          },
          error: function(){
            console.log("Erro: ");
          }
        });
      });
    });

    function format_data(data){
      if(data){
        return data.split('-').reverse().join('/');
      }
    }

    function format_telefone(telefone){
      if(telefone){
        telefone = telefone.replace(/\D/g, '');
        if(telefone.length == 10){
          return `(${telefone.substring(0, 2)}) ${telefone.substring(2, 6)}-${telefone.substring(6)}`;
        } 
        else if(telefone.length == 11){
          return `(${telefone.substring(0, 2)}) ${telefone.substring(2, 7)}-${telefone.substring(7)}`;
        } 
        else{
          return telefone;
        }
      }
    }

    function render_table(dados){
      if(dados.length != 0){
        let tabela = "<table style='width: 80%;' class='table' id='table-data'><thead class='table-dark'><tr><th>Nome</th><th>Data de Nascimento</th><th>E-mail</th><th>Celular para contato</th><th>Ações</th></tr></thead>";
        
        dados.forEach(item => {
          tabela += "<tbody><tr>" 
          + '<td>' + item['nome'] + '</td>' 
          + '<td>' + format_data(item['data_nascimento']) + '</td>'
          + '<td>' + item['email'] + '</td>'
          + '<td>' + format_telefone(item['celular']) + '</td>';
            
          tabela += '<td>'
          + '<div>'
          + '<img class="editar" data-id="' + item.id + '" src="assets\\editar.png" alt="editar"></img>'
          + '<img class="excluir" data-id="' + item.id + '" src="assets\\excluir.png" alt="excluir"></img>'
          + '</div>'
          + '</td>';
          tabela += "</tr></tbody>";
          
        });
        tabela += '</table)>';
        
        $("#spaceTable").html(tabela);

        $(".editar").click(function(event){
          var itemId = $(this).data("id");

          let = contatoEdit = dados.find(item => item.id == itemId);
        
          $('#spaceModal').load('modal.html', function(){
            if(contatoEdit){
              $('#idEdit').val(contatoEdit.id);
              $('#nomeEdit').val(contatoEdit.nome);

              let dataFormatada = format_data(contatoEdit.data_nascimento);
              $('#dataEdit').val(dataFormatada);

              aplicar_mask_data('#dataEdit');
              aplicar_mask_telefone('#telefoneEdit');
              aplicar_mask_telefone('#celularEdit');

              $('#mailEdit').val(contatoEdit.email);
              $('#profissaoEdit').val(contatoEdit.profissao); 
              $('#telefoneEdit').val(contatoEdit.telefone);
              $('#celularEdit').val(contatoEdit.celular);
              $('#checkWppEdit').prop('checked',contatoEdit.celular_wpp == 1);
              $('#notifyEmailEdit').prop('checked',contatoEdit.notify_email == 1);
              $('#notifySmsEdit').prop('checked',contatoEdit.notify_sms == 1);
            }
            $('#modalEdit').modal('show');
            $('#btnSalvarEdit').click(function(event){
              $('#formEditar').submit();
            });
          
            $('#formEditar').submit(function(event){
              event.preventDefault();
              var dataFormatada = formatar_data_envio($('#dataEdit').val());
              $('#dataEdit').val(dataFormatada);
              var telefoneFormatado = formatar_telefone_envio($('#telefoneEdit').val());
              $('#telefoneEdit').val(telefoneFormatado);
              var celularFormatado = formatar_telefone_envio($('#celularEdit').val());
              $('#celularEdit').val(celularFormatado);
              $.ajax({
                data: $(this).serialize(),
                url: "router.php?action=update", 
                type: "PUT",
                dataType: "json",
                success: function(response){
                  console.log("Resposta do servidor: " + response);
                  $('#modalEdit').modal('hide');
                  get_dados_table();
                },
                error: function(){
                  console.log("Erro: ");
                }
              });
            });
          });
        });
          
        $(".excluir").click(function(event){
          var itemId = $(this).data("id");
        });
      }
    }

  </script>
</body>
</html>